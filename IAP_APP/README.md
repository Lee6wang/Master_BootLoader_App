# STM32F407VET6 BOOTL_APP

## 项目简介

这是一个基于STM32F407VET6微控制器的嵌入式应用程序，具有Bootloader功能。该项目实现了固件升级功能，允许通过串口通信对设备进行远程固件更新。该应用程序使用FreeRTOS实时操作系统来管理任务调度。

## 功能特性

- 基于STM32F407VET6微控制器开发
- 集成FreeRTOS实时操作系统
- 支持通过UART接口进行固件升级
- 实现了完整的Bootloader功能
- 支持固件校验和版本管理
- 使用HAL库进行硬件抽象

## 系统架构

### 硬件资源分配

- MCU: STM32F407VET6
- LED指示灯:
  - PC5: 红色LED
  - PB2: 蓝色LED
- 串口通信: USART1用于固件升级通信

### Flash分区布局

| 地址范围           | 扇区  | 用途           | 大小     |
|-------------------|-------|----------------|----------|
| 0x08000000-0x08007FFF | 0-1   | Bootloader区   | 32KB     |
| 0x08008000-0x0801FFFF | 2-4   | Application区  | 96KB     |
| 0x08020000-0x0805FFFF | 5-6   | Download缓冲区 | 256KB    |
| 0x08007F00         | 特殊  | 元数据存储区   | 256字节  |

### 固件升级流程

1. 设备启动时检查元数据标志位
2. 如果有新固件待升级，则将固件从Download区搬运到Application区
3. 更新完成后清除升级标志位
4. 正常启动应用程序

## 通信协议

设备通过UART接口使用自定义通信协议进行固件升级，协议帧结构如下：

```
帧头(2B) | 命令字(1B) | 序列号(1B) | 数据长度(2B) | 数据(NB) | CRC(2B)
```

支持的命令字:
- 0x01: 握手命令
- 0x02: 开始升级命令
- 0x03: 数据传输命令
- 0x04: 结束升级命令
- 0x05: 查询版本命令
- 0x06: 应答命令

## 项目结构

```
.
├── Core                    # 核心代码
│   ├── Inc                 # 头文件
│   └── Src                 # 源文件
├── Drivers                 # 驱动程序
│   ├── CMSIS               # ARM Cortex-M内核接口
│   └── STM32F4xx_HAL_Driver # ST官方HAL库
├── HardWare                # 硬件相关代码
│   ├── Inc                 # 硬件接口头文件
│   └── Src                 # 硬件实现源文件
├── Middlewares             # 第三方中间件
│   └── Third_Party\FreeRTOS # FreeRTOS实时操作系统
└── cmake                   # CMake构建配置
```

## 主要模块说明

### 1. 通信协议模块 (comm_proto)

负责处理UART通信协议，解析接收到的数据帧，并封装发送数据帧。

### 2. 升级管理模块 (update_manager)

管理整个固件升级过程，包括开始升级、接收数据块、完成升级等状态管理。

### 3. Flash操作模块 (FlashCV)

提供底层Flash操作接口，包括擦除、写入、读取和数据校验等功能。

## 开发环境

- 操作系统: Windows 10/11
- IDE: CLion 2025.2.4
- 编译器: GCC ARM Embedded
- 构建系统: CMake
- 调试工具: OpenOCD/DAPLink

## 编译和烧录

### 编译项目

使用CLion打开项目，选择适当的CMake preset配置，然后构建项目。

或者在命令行中执行:

```bash
mkdir build
cd build
cmake ..
make
```

### 烧录固件

使用ST-Link或其他兼容调试器烧录生成的HEX或BIN文件。

## 使用方法

1. 连接目标板到PC的USART1串口
2. 使用串口调试工具发送固件升级命令
3. 按照通信协议进行固件传输
4. 升级完成后设备会自动重启并运行新固件

## 注意事项

1. 确保供电稳定，升级过程中断电可能导致设备变砖
2. Flash操作有一定风险，请谨慎修改相关代码
3. 固件大小不能超过Application区容量限制(96KB)
4. 升级前请确保新固件经过充分测试

## 许可证

本项目根据LICENSE文件中的条款进行许可。

## 联系方式

如有任何问题，请提交Issue或联系项目维护者。